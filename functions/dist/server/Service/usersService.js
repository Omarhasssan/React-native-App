Object.defineProperty(exports,"__esModule",{value:true});exports.usersService=undefined;var _FormValidation=require('../helpers/FormValidation');var _firebase=require('../config/firebase');var _firebase2=_interopRequireDefault(_firebase);var _Service=require('../Service');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var _=require('lodash');var usersService=exports.usersService={saveUser:saveUser,checkUserFound:checkUserFound,findByName:findByName,getUserById:getUserById,updateUser:updateUser,onUserHasMatchesToObserve:onUserHasMatchesToObserve,onUserHasTeam:onUserHasTeam,getUsers:getUsers,getUserNotificationToken:getUserNotificationToken};function saveUser(user){return(0,_FormValidation.validateSignUpForm)(user).then(function(){var userRef=_firebase2.default.database().ref('users').push();user.id=userRef.key;userRef.set(user);return Promise.resolve(user);}).catch(function(errMsg){return Promise.reject(errMsg);});}function findByName(name,tableName){return new Promise(function(resolve,reject){return _firebase2.default.database().ref(tableName).on('value',function(snapshot){snapshot.forEach(function(data){if(data.toJSON().name==name)return resolve(data.toJSON());});return reject();});});}function checkUserFound(user){return findByName(user.name,'users').then(function(returnedUser){if(returnedUser.password==user.password){console.log('here3');return Promise.resolve(returnedUser);}return Promise.reject();}).catch(function(){return Promise.reject();});}function getUserById(userId){var _this=this;var withoutMatches=arguments[1]=='withoutTeamMatches';return new Promise(function(resolve,reject){return _firebase2.default.database().ref('users'+'/'+userId).once('value',function _callee(snapshot){return regeneratorRuntime.async(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:resolve(snapshot.toJSON());case 1:case'end':return _context.stop();}}},null,_this);});});}function updateUser(route,value){return _firebase2.default.database().ref(route).set(value);}function getUserNotificationToken(userId){return _firebase2.default.database().ref('users/'+userId+'/notificationToken').once('value');}function onUserHasMatchesToObserve(userId){var _this2=this;return new Promise(function(resolve,reject){return _firebase2.default.database().ref('MatchesToObserve').on('child_added',function _callee2(snapshot){var match,data,room;return regeneratorRuntime.async(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:match={};data=snapshot.toJSON();if(!(userId==data.observerId)){_context2.next=11;break;}_context2.next=5;return regeneratorRuntime.awrap(_Service.roomsService.getRoomById(data.roomId));case 5:room=_context2.sent;match.firstTeam=room.teamOwner;if(room.joinedTeam)match.secondTeam=room.joinedTeam;if(room.settings.data)match.date=room.settings.date;if(room.settings.location)match.location=room.settings.location;resolve(match);case 11:case'end':return _context2.stop();}}},null,_this2);});});}function onUserHasTeam(userId){var _this3=this;var first,done;return regeneratorRuntime.async(function onUserHasTeam$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:first=true;done=false;return _context4.abrupt('return',new Promise(function(resolve,reject){_firebase2.default.database().ref('users'+'/'+userId).on('value',function _callee3(snap){var user,updatedUser;return regeneratorRuntime.async(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:if(!first){_context3.next=4;break;}first=false;_context3.next=12;break;case 4:user=snap.toJSON();if(!(user.teamId&&!done)){_context3.next=12;break;}updatedUser={};_context3.next=9;return regeneratorRuntime.awrap(_Service.teamsService.getTeamById(user.teamId));case 9:updatedUser.team=_context3.sent;done=true;resolve(updatedUser);case 12:case'end':return _context3.stop();}}},null,_this3);});}));case 3:case'end':return _context4.stop();}}},null,this);}function getUsers(){var arr=[];return new Promise(function(resolve,reject){return _firebase2.default.database().ref('users').once('value',function(snapshot){snapshot.forEach(function(user){arr.push(user.toJSON());});return resolve(arr);});});}