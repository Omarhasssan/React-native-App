Object.defineProperty(exports,"__esModule",{value:true});exports.teamsService=undefined;var _firebase=require('../config/firebase');var _firebase2=_interopRequireDefault(_firebase);var _Service=require('../Service');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var _=require('lodash');var teamsService=exports.teamsService={getTeams:getTeams,onTeamHasNewPlayer:onTeamHasNewPlayer,addTeam:addTeam,getTeamPlayers:getTeamPlayers,updateTeamPlayers:updateTeamPlayers,getTeamMatches:getTeamMatches,addMatchToTeam:addMatchToTeam,getTeamById:getTeamById,updateTeam:updateTeam};function getTeams(){var _this=this;var arr,res;return regeneratorRuntime.async(function getTeams$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:arr=[],res=void 0;return _context2.abrupt('return',new Promise(function(resolve,reject){_firebase2.default.database().ref('teams').once('value',function _callee(snapshot){var teams;return regeneratorRuntime.async(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:teams=snapshot.toJSON();_context.t0=regeneratorRuntime.keys(teams);case 2:if((_context.t1=_context.t0()).done){_context.next=17;break;}indx=_context.t1.value;if(!teams[indx].players){_context.next=14;break;}_context.t2=regeneratorRuntime.keys(teams[indx].players);case 6:if((_context.t3=_context.t2()).done){_context.next=13;break;}i=_context.t3.value;_context.next=10;return regeneratorRuntime.awrap(_Service.usersService.getUserById(teams[indx].players[i]));case 10:teams[indx].players[i]=_context.sent;_context.next=6;break;case 13:teams[indx].players=Object.values(teams[indx].players);case 14:arr.push(teams[indx]);_context.next=2;break;case 17:resolve(arr);case 18:case'end':return _context.stop();}}},null,_this);});}));case 2:case'end':return _context2.stop();}}},null,this);}function onTeamHasNewPlayer(){var _this2=this;var teams,teamsLen,cnt,first;return regeneratorRuntime.async(function onTeamHasNewPlayer$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_context4.next=2;return regeneratorRuntime.awrap(getTeams());case 2:teams=_context4.sent;teamsLen=teams.length;cnt=0;first=true;return _context4.abrupt('return',new Promise(function(resolve,reject){_firebase2.default.database().ref('teams').on('child_added',function(team){cnt++;if(cnt>=teamsLen)first=false;team=team.toJSON();console.log('team_chiled_added',team.name);return _firebase2.default.database().ref('teams'+'/'+team.id+'/'+'players').on('child_added',function _callee2(playerId){var updatedTeam;return regeneratorRuntime.async(function _callee2$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:updatedTeam={};if(first){_context3.next=10;break;}console.log('player_chiled_added',playerId,'teamName',team.name);updatedTeam.id=team.id;_context3.next=6;return regeneratorRuntime.awrap(_Service.usersService.getUserById(playerId.toJSON()));case 6:updatedTeam.player=_context3.sent;console.log('after await',updatedTeam.player);resolve(updatedTeam);console.log('after resolve');case 10:case'end':return _context3.stop();}}},null,_this2);});});}));case 7:case'end':return _context4.stop();}}},null,this);}function addTeam(team){var teamsRef=_firebase2.default.database().ref('teams').push();team.id=teamsRef.key;return teamsRef.set(team).then(function(){return Promise.resolve(teamsRef.key);});}function getTeamPlayers(teamId){var arr=[];return new Promise(function(resolve,reject){return _firebase2.default.database().ref('teams'+'/'+teamId+'/'+'players').once('value',function(snapshot){if(snapshot.toJSON()!=null)return resolve(Object.values(snapshot.toJSON()));return resolve([]);});});}function updateTeamPlayers(teamId,playerId){return getTeamPlayers(teamId).then(function(teamPlayers){teamPlayers.push(playerId);_firebase2.default.database().ref('teams'+'/'+teamId+'/'+'players').set(teamPlayers);});}function updateTeam(route,value){return _firebase2.default.database().ref(route).set(value);}function getTeamMatches(teamId){return new Promise(function(resolve,reject){return _firebase2.default.database().ref('teams'+'/'+teamId+'/'+'matches').once('value',function(snapshot){var matches=snapshot.toJSON();return resolve(matches||[]);});resolve([]);});}function addMatchToTeam(teamId,matchId){var matches;return regeneratorRuntime.async(function addMatchToTeam$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:_context5.next=2;return regeneratorRuntime.awrap(getTeamMatches(teamId));case 2:matches=_context5.sent;_firebase2.default.database().ref('teams'+'/'+teamId+'/'+'matches'+'/'+(Object.keys(matches).length||0)).set(matchId);case 4:case'end':return _context5.stop();}}},null,this);}function getTeamById(teamId){var _this3=this;var withoutMatches=arguments[1]=='withoutTeamMatches';return new Promise(function(resolve,reject){_firebase2.default.database().ref('teams'+'/'+teamId).once('value',function _callee3(snapshot){var team,teamObj,index,_index,match;return regeneratorRuntime.async(function _callee3$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:team=snapshot.toJSON();teamObj={players:{},matches:[]};teamObj.id=team.id;teamObj.name=team.name;teamObj.records=team.records;_context6.t0=regeneratorRuntime.keys(team.players);case 6:if((_context6.t1=_context6.t0()).done){_context6.next=13;break;}index=_context6.t1.value;_context6.next=10;return regeneratorRuntime.awrap(_Service.usersService.getUserById(team.players[index]));case 10:teamObj.players[index]=_context6.sent;_context6.next=6;break;case 13:if(withoutMatches){_context6.next=23;break;}_context6.t2=regeneratorRuntime.keys(team.matches);case 15:if((_context6.t3=_context6.t2()).done){_context6.next=23;break;}_index=_context6.t3.value;_context6.next=19;return regeneratorRuntime.awrap(_Service.matchesService.getMatchById(team.matches[_index],teamId));case 19:match=_context6.sent;teamObj.matches.push(match);_context6.next=15;break;case 23:resolve(teamObj);case 24:case'end':return _context6.stop();}}},null,_this3);});});}