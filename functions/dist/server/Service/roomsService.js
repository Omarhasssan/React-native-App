Object.defineProperty(exports,"__esModule",{value:true});exports.roomsService=undefined;var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};var _firebase=require('../config/firebase');var _firebase2=_interopRequireDefault(_firebase);var _Service=require('../Service');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var _=require('lodash');var roomsService=exports.roomsService={addRoom:addRoom,onRoomObserverStatusChanged:onRoomObserverStatusChanged,getRoomById:getRoomById,getRooms:getRooms,updateRoom:updateRoom};function addRoom(room){var roomRef=_firebase2.default.database().ref('Rooms').push();room.id=roomRef.key;roomRef.set(room);}function updateRoom(route,value){return _firebase2.default.database().ref(route).set(value);}function onRoomObserverStatusChanged(){var _this=this;var first=true;return new Promise(function(resolve,reject){_firebase2.default.database().ref('Rooms').on('child_added',function(room){console.log('room added');room=room.toJSON();_firebase2.default.database().ref('Rooms'+'/'+room.id+'/'+'settings'+'/'+'observer'+'/'+'status').on('value',function _callee(status){var updatedRoom;return regeneratorRuntime.async(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:console.log('roomObserver status changed');if(!first){_context.next=5;break;}first=false;_context.next=11;break;case 5:console.log('not first');_context.next=8;return regeneratorRuntime.awrap(getRoomById(room.id));case 8:updatedRoom=_context.sent;resolve(updatedRoom);first=false;case 11:case'end':return _context.stop();}}},null,_this);});});});}function getRoomDetails(room){var newroom;return regeneratorRuntime.async(function getRoomDetails$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:newroom={settings:{}};_context2.next=3;return regeneratorRuntime.awrap(_Service.teamsService.getTeamById(room.teamOwner));case 3:newroom.teamOwner=_context2.sent;newroom.name=room.name;newroom.id=room.id;if(!room.joinedTeam){_context2.next=10;break;}_context2.next=9;return regeneratorRuntime.awrap(_Service.teamsService.getTeamById(room.joinedTeam));case 9:newroom.joinedTeam=_context2.sent;case 10:if(!(room.settings&&_.has(room.settings,'observer'))){_context2.next=16;break;}newroom.settings={observer:{info:{},status:''}};_context2.next=14;return regeneratorRuntime.awrap(_Service.usersService.getUserById(room.settings.observer.id));case 14:newroom.settings.observer.info=_context2.sent;newroom.settings.observer.status=room.settings.observer.status;case 16:if(room.settings&&_.has(room.settings,'date')){newroom.settings=_extends({},newroom.settings,{date:''});newroom.settings.date=room.settings.date;}if(room.settings&&_.has(room.settings,'location')){newroom.settings=_extends({},newroom.settings,{location:''});newroom.settings.location=room.settings.location;}newroom.settings.GuestReady=room.settings.GuestReady;newroom.settings.OwnerReady=room.settings.OwnerReady;return _context2.abrupt('return',newroom);case 21:case'end':return _context2.stop();}}},null,this);}function getRoomById(roomId){var _this2=this;return new Promise(function(resolve,reject){_firebase2.default.database().ref('Rooms'+'/'+roomId).once('value',function _callee2(snapshot){var room,newroom;return regeneratorRuntime.async(function _callee2$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:room=snapshot.toJSON();_context3.next=3;return regeneratorRuntime.awrap(getRoomDetails(room));case 3:newroom=_context3.sent;resolve(newroom);case 5:case'end':return _context3.stop();}}},null,_this2);});});}function getRooms(){var _this3=this;var arr;return regeneratorRuntime.async(function getRooms$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:arr=[];return _context5.abrupt('return',new Promise(function(resolve,reject){_firebase2.default.database().ref('Rooms').once('value',function _callee3(snapshot){var rooms,indx,newroom;return regeneratorRuntime.async(function _callee3$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:rooms=snapshot.toJSON();_context4.t0=regeneratorRuntime.keys(rooms);case 2:if((_context4.t1=_context4.t0()).done){_context4.next=10;break;}indx=_context4.t1.value;_context4.next=6;return regeneratorRuntime.awrap(getRoomDetails(rooms[indx]));case 6:newroom=_context4.sent;arr.push(newroom);_context4.next=2;break;case 10:resolve(arr);case 11:case'end':return _context4.stop();}}},null,_this3);});}));case 2:case'end':return _context5.stop();}}},null,this);}