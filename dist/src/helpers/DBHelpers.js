Object.defineProperty(exports,"__esModule",{value:true});exports.DBHelpers=undefined;var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};var _firebase=require('../config/firebase');var _firebase2=_interopRequireDefault(_firebase);var _FormValidation=require('./FormValidation');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var _=require('lodash');var DBHelpers=exports.DBHelpers={getRooms:getRooms,getRequestByteamId:getRequestByteamId,saveUser:saveUser,findByName:findByName,checkUserFound:checkUserFound,getUsers:getUsers,updateUser:updateUser,addTeam:addTeam,addTeamRequest:addTeamRequest,getUserRequest:getUserRequest,getTeamById:getTeamById,getRequestById:getRequestById,updateRequest:updateRequest,updateTeam:updateTeam,addRoom:addRoom,getUserById:getUserById,updateRoom:updateRoom,getTeams:getTeams,updateTeamPlayers:updateTeamPlayers,onRequestStatusChanged:onRequestStatusChanged,getRoomById:getRoomById,addObservingRequest:addObservingRequest,removeObservingRequest:removeObservingRequest,getObservingRequest:getObservingRequest,onTeamHasNewPlayer:onTeamHasNewPlayer,onUserHasTeam:onUserHasTeam,onUserHasMatchesToObserve:onUserHasMatchesToObserve,onRoomObserverStatusChanged:onRoomObserverStatusChanged};function removeObservingRequest(reqId){_firebase2.default.database().ref('ObservingRequests'+'/'+reqId).remove();}function getObservingRequest(roomId,userId){return new Promise(function(resolve,reject){_firebase2.default.database().ref('ObservingRequests').once('value',function(snapshot){var reqs=snapshot.toJSON();for(i in reqs){if(reqs[i].roomId==roomId&&reqs[i].playerId==userId)return resolve(reqs[i]);}});});}function getUserRequest(userId){var _this=this;var arr={teamRequests:[],observingRequests:[]};return new Promise(function(resolve,reject){_firebase2.default.database().ref('TeamRequests').once('value',function _callee2(snapshot){var reqs,newReq;return regeneratorRuntime.async(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:reqs=snapshot.toJSON();_context2.t0=regeneratorRuntime.keys(reqs);case 2:if((_context2.t1=_context2.t0()).done){_context2.next=18;break;}index=_context2.t1.value;newReq={};if(!(reqs[index].playerId==userId&&reqs[index].status=='PENDING')){_context2.next=16;break;}_context2.next=8;return regeneratorRuntime.awrap(getTeamById(reqs[index].teamId));case 8:newReq.team=_context2.sent;newReq.status=reqs[index].status;newReq.type='joinTeam';_context2.next=13;return regeneratorRuntime.awrap(getUserById(reqs[index].playerId));case 13:newReq.player=_context2.sent;newReq.id=reqs[index].id;arr.teamRequests.push(newReq);case 16:_context2.next=2;break;case 18:_firebase2.default.database().ref('ObservingRequests').once('value',function _callee(snapshot){var reqs,_newReq;return regeneratorRuntime.async(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:reqs=snapshot.toJSON();_context.t0=regeneratorRuntime.keys(reqs);case 2:if((_context.t1=_context.t0()).done){_context.next=18;break;}index=_context.t1.value;_newReq={};if(!(reqs[index].playerId==userId&&reqs[index].status=='PENDING')){_context.next=16;break;}_context.next=8;return regeneratorRuntime.awrap(getRoomById(reqs[index].roomId));case 8:_newReq.room=_context.sent;_newReq.status=reqs[index].status;_newReq.type='observing';_context.next=13;return regeneratorRuntime.awrap(getUserById(reqs[index].playerId));case 13:_newReq.player=_context.sent;_newReq.id=reqs[index].id;arr.observingRequests.push(_newReq);case 16:_context.next=2;break;case 18:resolve(arr);case 19:case'end':return _context.stop();}}},null,_this);});case 19:case'end':return _context2.stop();}}},null,_this);});});}function getUsers(){var arr=[];return new Promise(function(resolve,reject){return _firebase2.default.database().ref('users').once('value',function(snapshot){snapshot.forEach(function(user){arr.push(user.toJSON());});return resolve(arr);});});}function getRoomById(roomId){var _this2=this;return new Promise(function(resolve,reject){_firebase2.default.database().ref('Rooms'+'/'+roomId).once('value',function _callee3(snapshot){var room,newroom;return regeneratorRuntime.async(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:room=snapshot.toJSON();newroom={};_context3.next=4;return regeneratorRuntime.awrap(getTeamById(room.teamOwner));case 4:newroom.teamOwner=_context3.sent;newroom.name=room.name;newroom.id=room.id;if(!room.joinedTeam){_context3.next=11;break;}_context3.next=10;return regeneratorRuntime.awrap(getTeamById(room.joinedTeam));case 10:newroom.joinedTeam=_context3.sent;case 11:if(!(room.settings&&_.has(room.settings,'observer'))){_context3.next=17;break;}newroom.settings={observer:{info:{},status:''}};_context3.next=15;return regeneratorRuntime.awrap(getUserById(room.settings.observer.id));case 15:newroom.settings.observer.info=_context3.sent;newroom.settings.observer.status=room.settings.observer.status;case 17:if(room.settings&&_.has(room.settings,'date')){newroom.settings=_extends({},newroom.settings,{date:''});newroom.settings.date=room.settings.date;}if(room.settings&&_.has(room.settings,'location')){newroom.settings=_extends({},newroom.settings,{location:''});newroom.settings.location=room.settings.location;}resolve(newroom);case 20:case'end':return _context3.stop();}}},null,_this2);});});}function getRooms(){var _this3=this;var arr,res;return regeneratorRuntime.async(function getRooms$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:arr=[],res=void 0;return _context5.abrupt('return',new Promise(function(resolve,reject){_firebase2.default.database().ref('Rooms').once('value',function _callee4(snapshot){var rooms,_indx,newroom;return regeneratorRuntime.async(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:rooms=snapshot.toJSON();_context4.t0=regeneratorRuntime.keys(rooms);case 2:if((_context4.t1=_context4.t0()).done){_context4.next=25;break;}_indx=_context4.t1.value;newroom={};_context4.next=7;return regeneratorRuntime.awrap(getTeamById(rooms[_indx].teamOwner));case 7:newroom.teamOwner=_context4.sent;newroom.name=rooms[_indx].name;newroom.id=rooms[_indx].id;if(!rooms[_indx].joinedTeam){_context4.next=14;break;}_context4.next=13;return regeneratorRuntime.awrap(getTeamById(rooms[_indx].joinedTeam));case 13:newroom.joinedTeam=_context4.sent;case 14:if(!(rooms[_indx].settings&&_.has(rooms[_indx].settings,'observer'))){_context4.next=20;break;}newroom.settings={observer:{info:{},status:''}};_context4.next=18;return regeneratorRuntime.awrap(getUserById(rooms[_indx].settings.observer.id));case 18:newroom.settings.observer.info=_context4.sent;newroom.settings.observer.status=rooms[_indx].settings.observer.status;case 20:if(rooms[_indx].settings&&_.has(rooms[_indx].settings,'date')){newroom.settings=_extends({},newroom.settings,{date:''});newroom.settings.date=rooms[_indx].settings.date;}if(rooms[_indx].settings&&_.has(rooms[_indx].settings,'location')){newroom.settings=_extends({},newroom.settings,{location:''});newroom.settings.location=rooms[_indx].settings.location;}arr.push(newroom);_context4.next=2;break;case 25:resolve(arr);case 26:case'end':return _context4.stop();}}},null,_this3);});}));case 2:case'end':return _context5.stop();}}},null,this);}function getTeams(){var _this4=this;var arr,res;return regeneratorRuntime.async(function getTeams$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:arr=[],res=void 0;return _context7.abrupt('return',new Promise(function(resolve,reject){_firebase2.default.database().ref('teams').once('value',function _callee5(snapshot){var teams;return regeneratorRuntime.async(function _callee5$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:teams=snapshot.toJSON();_context6.t0=regeneratorRuntime.keys(teams);case 2:if((_context6.t1=_context6.t0()).done){_context6.next=17;break;}indx=_context6.t1.value;if(!teams[indx].players){_context6.next=14;break;}_context6.t2=regeneratorRuntime.keys(teams[indx].players);case 6:if((_context6.t3=_context6.t2()).done){_context6.next=13;break;}i=_context6.t3.value;_context6.next=10;return regeneratorRuntime.awrap(getUserById(teams[indx].players[i]));case 10:teams[indx].players[i]=_context6.sent;_context6.next=6;break;case 13:teams[indx].players=Object.values(teams[indx].players);case 14:arr.push(teams[indx]);_context6.next=2;break;case 17:resolve(arr);case 18:case'end':return _context6.stop();}}},null,_this4);});}));case 2:case'end':return _context7.stop();}}},null,this);}function onRequestStatusChanged(){return new Promise(function(resolve,reject){_firebase2.default.database().ref('TeamRequests').on('child_changed',function(data){var req=data.toJSON();if(req.status=='ACCEPTED'){resolve(req);}});});}function onTeamHasNewPlayer(){var _this5=this;var teams,teamsLen,cnt,first;return regeneratorRuntime.async(function onTeamHasNewPlayer$(_context9){while(1){switch(_context9.prev=_context9.next){case 0:_context9.next=2;return regeneratorRuntime.awrap(getTeams());case 2:teams=_context9.sent;teamsLen=teams.length;cnt=0;first=true;return _context9.abrupt('return',new Promise(function(resolve,reject){_firebase2.default.database().ref('teams').on('child_added',function(team){cnt++;if(cnt>=teamsLen)first=false;team=team.toJSON();console.log('team_chiled_added',team.name);return _firebase2.default.database().ref('teams'+'/'+team.id+'/'+'players').on('child_added',function _callee6(playerId){var updatedTeam;return regeneratorRuntime.async(function _callee6$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:updatedTeam={};if(first){_context8.next=10;break;}console.log('player_chiled_added',playerId,'teamName',team.name);updatedTeam.id=team.id;_context8.next=6;return regeneratorRuntime.awrap(getUserById(playerId.toJSON()));case 6:updatedTeam.player=_context8.sent;console.log('after await',updatedTeam.player);resolve(updatedTeam);console.log('after resolve');case 10:case'end':return _context8.stop();}}},null,_this5);});});}));case 7:case'end':return _context9.stop();}}},null,this);}function onRoomObserverStatusChanged(){var _this6=this;var first=true;return new Promise(function(resolve,reject){_firebase2.default.database().ref('Rooms').on('child_added',function(room){console.log('room added');room=room.toJSON();_firebase2.default.database().ref('Rooms'+'/'+room.id+'/'+'settings'+'/'+'observer'+'/'+'status').on('value',function _callee7(status){var updatedRoom;return regeneratorRuntime.async(function _callee7$(_context10){while(1){switch(_context10.prev=_context10.next){case 0:console.log('roomObserver status changed');if(!first){_context10.next=5;break;}first=false;_context10.next=11;break;case 5:console.log('not first');_context10.next=8;return regeneratorRuntime.awrap(getRoomById(room.id));case 8:updatedRoom=_context10.sent;resolve(updatedRoom);first=false;case 11:case'end':return _context10.stop();}}},null,_this6);});});});}function onUserHasTeam(userId){var _this7=this;var first,done;return regeneratorRuntime.async(function onUserHasTeam$(_context12){while(1){switch(_context12.prev=_context12.next){case 0:first=true;done=false;return _context12.abrupt('return',new Promise(function(resolve,reject){_firebase2.default.database().ref('users'+'/'+userId).on('value',function _callee8(snap){var user,updatedUser;return regeneratorRuntime.async(function _callee8$(_context11){while(1){switch(_context11.prev=_context11.next){case 0:if(!first){_context11.next=4;break;}first=false;_context11.next=12;break;case 4:user=snap.toJSON();if(!(user.teamId&&!done)){_context11.next=12;break;}updatedUser={};_context11.next=9;return regeneratorRuntime.awrap(getTeamById(user.teamId));case 9:updatedUser.team=_context11.sent;done=true;resolve(updatedUser);case 12:case'end':return _context11.stop();}}},null,_this7);});}));case 3:case'end':return _context12.stop();}}},null,this);}function onUserHasMatchesToObserve(userId){var _this8=this;return new Promise(function(resolve,reject){return _firebase2.default.database().ref('MatchesToObserve').on('child_added',function _callee9(snapshot){var match,data,room;return regeneratorRuntime.async(function _callee9$(_context13){while(1){switch(_context13.prev=_context13.next){case 0:match={};data=snapshot.toJSON();if(!(userId==data.observerId)){_context13.next=11;break;}_context13.next=5;return regeneratorRuntime.awrap(getRoomById(data.roomId));case 5:room=_context13.sent;match.firstTeam=room.teamOwner;if(room.joinedTeam)match.secondTeam=room.joinedTeam;if(room.settings.data)match.date=room.settings.date;if(room.settings.location)match.location=room.settings.location;resolve(match);case 11:case'end':return _context13.stop();}}},null,_this8);});});}function addTeamRequest(Request){var req=_extends({},Request);var requestsRef=_firebase2.default.database().ref('TeamRequests').push();req.id=requestsRef.key;return requestsRef.set(req).then(function(){return Promise.resolve(req.id);});}function addObservingRequest(Request){var req=_extends({},Request);var requestsRef=_firebase2.default.database().ref('ObservingRequests').push();req.id=requestsRef.key;return requestsRef.set(req).then(function(){return Promise.resolve(req.id);});}function addRoom(room){var roomRef=_firebase2.default.database().ref('Rooms').push();room.id=roomRef.key;roomRef.set(room);}function addTeam(team){var teamsRef=_firebase2.default.database().ref('teams').push();team.id=teamsRef.key;teamsRef.set(team);}function getTeamPlayers(teamId){var arr=[];return new Promise(function(resolve,reject){return _firebase2.default.database().ref('teams'+'/'+teamId+'/'+'players').once('value',function(snapshot){if(snapshot.toJSON()!=null)return resolve(Object.values(snapshot.toJSON()));return resolve([]);});});}function updateTeamPlayers(teamId,playerId){return getTeamPlayers(teamId).then(function(teamPlayers){teamPlayers.push(playerId);_firebase2.default.database().ref('teams'+'/'+teamId+'/'+'players').set(teamPlayers);});}function updateTeam(route,value){return _firebase2.default.database().ref('route').set(value);}function updateRoom(route,value){return _firebase2.default.database().ref(route).set(value);}function updateUser(route,value){return _firebase2.default.database().ref(route).set(value);}function getTeamById(teamId){var _this9=this;return new Promise(function(resolve,reject){return _firebase2.default.database().ref('teams'+'/'+teamId).once('value',function _callee10(snapshot){var team,_index;return regeneratorRuntime.async(function _callee10$(_context14){while(1){switch(_context14.prev=_context14.next){case 0:team=snapshot.toJSON();if(!team.players){_context14.next=10;break;}_context14.t0=regeneratorRuntime.keys(team.players);case 3:if((_context14.t1=_context14.t0()).done){_context14.next=10;break;}_index=_context14.t1.value;_context14.next=7;return regeneratorRuntime.awrap(getUserById(team.players[_index]));case 7:team.players[_index]=_context14.sent;_context14.next=3;break;case 10:return _context14.abrupt('return',resolve(team));case 11:case'end':return _context14.stop();}}},null,_this9);});});}function getUserById(userId){var _this10=this;return new Promise(function(resolve,reject){return _firebase2.default.database().ref('users'+'/'+userId).once('value',function _callee11(snapshot){return regeneratorRuntime.async(function _callee11$(_context15){while(1){switch(_context15.prev=_context15.next){case 0:return _context15.abrupt('return',resolve(snapshot.toJSON()));case 1:case'end':return _context15.stop();}}},null,_this10);});});}function getRequestById(requestId){return new Promise(function(resolve,reject){return _firebase2.default.database().ref('TeamRequests'+'/'+requestId).on('value',function(snapshot){return resolve(snapshot.toJSON());});});}function getRequestByteamId(teamId){var arr=[];return new Promise(function(resolve,reject){return _firebase2.default.database().ref('TeamRequests').on('value',function(snapshot){var reqs=snapshot.toJSON();for(i in reqs){if(reqs[i].teamId==teamId)arr.push(reqs[i]);}return resolve(arr);});});}function updateRequest(requestId,reqType){if(reqType=='joinTeam')return _firebase2.default.database().ref('TeamRequests'+'/'+requestId+'/'+'status').set('ACCEPTED');else return _firebase2.default.database().ref('ObservingRequests'+'/'+requestId+'/'+'status').set('ACCEPTED');}function saveUser(user){return(0,_FormValidation.validateSignUpForm)(user).then(function(){return _firebase2.default.auth().signInAnonymously().then(function(){var userRef=_firebase2.default.database().ref('users').push();user.id=userRef.key;userRef.set(user);return Promise.resolve(user);});}).catch(function(errMsg){return Promise.reject(errMsg);});}function checkUserFound(user){return findByName(user.name,'users').then(function(returnedUser){if(returnedUser.password==user.password){console.log('here3');return Promise.resolve(returnedUser);}return Promise.reject();}).catch(function(){return Promise.reject();});}function findByName(name,tableName){return new Promise(function(resolve,reject){return _firebase2.default.auth().signInAnonymously().then(function(){_firebase2.default.database().ref(tableName).on('value',function(snapshot){snapshot.forEach(function(data){if(data.toJSON().name==name)return resolve(data.toJSON());});return reject();});});});}